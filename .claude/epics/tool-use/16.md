---
name: Google Tasks Operations
status: open
created: 2025-10-29T21:30:40Z
updated: 2025-10-29T21:54:09Z
github: https://github.com/zach-fau/home-assistant/issues/16
depends_on: [12, 15]
parallel: false
conflicts_with: []
---

# Task: Google Tasks Operations

## Description

Implement voice-controlled Google Tasks operations: create tasks, list tasks, complete tasks, and mark tasks as done. Build function schemas for OpenAI, register with the function calling framework, and test multi-turn task management conversations.

**Key Outcome:** "Alex, add buy milk to my tasks" creates a task, "What's on my task list?" reads tasks aloud, task management is faster than using the app.

## Acceptance Criteria

- [ ] Function schemas defined for: `create_task`, `list_tasks`, `complete_task`
- [ ] `create_task` works with title, optional notes, optional due date
- [ ] `list_tasks` retrieves and formats tasks for voice output
- [ ] `complete_task` marks task as done by title or ID
- [ ] Default task list used (or configurable in .env)
- [ ] Functions registered in `register_google_functions()`
- [ ] Multi-turn conversations work (create, list, complete in sequence)
- [ ] Voice responses are natural and concise
- [ ] Error handling for API failures
- [ ] Tested with 5+ task operations

## Technical Details

### Files to Modify
1. `pipecat-quickstart/functions/google_tasks.py` - Add task operation handlers
2. `pipecat-quickstart/functions/__init__.py` - Register Google functions
3. `pipecat-quickstart/.env` - Add default task list ID (optional)

### Implementation Approach

**1. Task Operation Handlers (`functions/google_tasks.py`):**
```python
from pipecat.services.openai import FunctionSchema
from googleapiclient.errors import HttpError
from datetime import datetime, timezone

# Get default task list
def get_default_tasklist_id(service):
    """Get the ID of the default task list (usually '@default')"""
    try:
        results = service.tasklists().list(maxResults=1).execute()
        lists = results.get('items', [])
        if lists:
            return lists[0]['id']
        return '@default'  # Fallback
    except HttpError as e:
        logger.error(f"Failed to get default task list: {e}")
        return '@default'

async def create_task_handler(title: str, notes: str = None, due_date: str = None):
    """
    Create a new task in Google Tasks

    Args:
        title: Task title
        notes: Optional task notes/description
        due_date: Optional due date (ISO format: YYYY-MM-DD)
    """
    try:
        service = get_google_tasks_service()
        tasklist_id = get_default_tasklist_id(service)

        task = {
            'title': title
        }

        if notes:
            task['notes'] = notes

        if due_date:
            # Convert to RFC 3339 format
            task['due'] = f"{due_date}T00:00:00.000Z"

        result = service.tasks().insert(
            tasklist=tasklist_id,
            body=task
        ).execute()

        logger.info(f"Created task: {title} (ID: {result['id']})")

        return {
            "success": True,
            "task_id": result['id'],
            "title": title,
            "message": f"Added '{title}' to your tasks"
        }

    except HttpError as e:
        logger.error(f"Failed to create task: {e}")
        return {
            "success": False,
            "error": str(e),
            "message": "Sorry, I couldn't create that task right now"
        }
    except Exception as e:
        logger.exception(f"Unexpected error creating task")
        return {
            "success": False,
            "error": str(e),
            "message": "Something went wrong creating the task"
        }

async def list_tasks_handler(max_results: int = 10, show_completed: bool = False):
    """
    List tasks from Google Tasks

    Args:
        max_results: Maximum number of tasks to return (default 10)
        show_completed: Include completed tasks (default False)
    """
    try:
        service = get_google_tasks_service()
        tasklist_id = get_default_tasklist_id(service)

        results = service.tasks().list(
            tasklist=tasklist_id,
            maxResults=max_results,
            showCompleted=show_completed
        ).execute()

        tasks = results.get('items', [])

        if not tasks:
            return {
                "success": True,
                "tasks": [],
                "count": 0,
                "message": "Your task list is empty"
            }

        # Format tasks for voice output
        task_list = []
        for i, task in enumerate(tasks, 1):
            task_info = {
                "number": i,
                "id": task['id'],
                "title": task['title'],
                "completed": task.get('status') == 'completed',
                "notes": task.get('notes', '')
            }
            task_list.append(task_info)

        # Create natural language summary
        if len(tasks) == 1:
            message = f"You have 1 task: {tasks[0]['title']}"
        else:
            titles = [t['title'] for t in tasks[:3]]  # First 3 tasks
            if len(tasks) > 3:
                message = f"You have {len(tasks)} tasks. The first few are: {', '.join(titles)}, and {len(tasks) - 3} more"
            else:
                message = f"You have {len(tasks)} tasks: {', '.join(titles)}"

        logger.info(f"Retrieved {len(tasks)} tasks")

        return {
            "success": True,
            "tasks": task_list,
            "count": len(tasks),
            "message": message
        }

    except HttpError as e:
        logger.error(f"Failed to list tasks: {e}")
        return {
            "success": False,
            "error": str(e),
            "message": "Sorry, I couldn't get your tasks right now"
        }
    except Exception as e:
        logger.exception(f"Unexpected error listing tasks")
        return {
            "success": False,
            "error": str(e),
            "message": "Something went wrong retrieving your tasks"
        }

async def complete_task_handler(task_identifier: str):
    """
    Mark a task as complete

    Args:
        task_identifier: Task title or task number from list (e.g., "1" or "buy milk")
    """
    try:
        service = get_google_tasks_service()
        tasklist_id = get_default_tasklist_id(service)

        # If identifier is a number, get task from list
        if task_identifier.isdigit():
            task_num = int(task_identifier)
            results = service.tasks().list(
                tasklist=tasklist_id,
                maxResults=task_num,
                showCompleted=False
            ).execute()

            tasks = results.get('items', [])
            if task_num > len(tasks):
                return {
                    "success": False,
                    "message": f"Task number {task_num} not found. You have {len(tasks)} tasks."
                }

            task_id = tasks[task_num - 1]['id']
            task_title = tasks[task_num - 1]['title']
        else:
            # Search for task by title
            results = service.tasks().list(
                tasklist=tasklist_id,
                maxResults=100,
                showCompleted=False
            ).execute()

            tasks = results.get('items', [])
            matching_task = None

            for task in tasks:
                if task_identifier.lower() in task['title'].lower():
                    matching_task = task
                    break

            if not matching_task:
                return {
                    "success": False,
                    "message": f"Couldn't find a task matching '{task_identifier}'"
                }

            task_id = matching_task['id']
            task_title = matching_task['title']

        # Mark task as complete
        task = service.tasks().get(tasklist=tasklist_id, task=task_id).execute()
        task['status'] = 'completed'

        service.tasks().update(
            tasklist=tasklist_id,
            task=task_id,
            body=task
        ).execute()

        logger.info(f"Completed task: {task_title}")

        return {
            "success": True,
            "task_id": task_id,
            "title": task_title,
            "message": f"Marked '{task_title}' as complete"
        }

    except HttpError as e:
        logger.error(f"Failed to complete task: {e}")
        return {
            "success": False,
            "error": str(e),
            "message": "Sorry, I couldn't complete that task"
        }
    except Exception as e:
        logger.exception(f"Unexpected error completing task")
        return {
            "success": False,
            "error": str(e),
            "message": "Something went wrong completing the task"
        }

# Function Schemas

def create_task_schema():
    return FunctionSchema(
        name="create_task",
        description="Create a new task in Google Tasks",
        parameters={
            "type": "object",
            "properties": {
                "title": {
                    "type": "string",
                    "description": "Task title or description"
                },
                "notes": {
                    "type": "string",
                    "description": "Optional additional notes or details"
                },
                "due_date": {
                    "type": "string",
                    "description": "Optional due date in YYYY-MM-DD format"
                }
            },
            "required": ["title"]
        }
    )

def list_tasks_schema():
    return FunctionSchema(
        name="list_tasks",
        description="List tasks from Google Tasks",
        parameters={
            "type": "object",
            "properties": {
                "max_results": {
                    "type": "integer",
                    "description": "Maximum number of tasks to return (default 10)",
                    "default": 10
                },
                "show_completed": {
                    "type": "boolean",
                    "description": "Include completed tasks (default False)",
                    "default": False
                }
            }
        }
    )

def complete_task_schema():
    return FunctionSchema(
        name="complete_task",
        description="Mark a task as complete",
        parameters={
            "type": "object",
            "properties": {
                "task_identifier": {
                    "type": "string",
                    "description": "Task number from list (e.g., '1', '2') or task title/keyword"
                }
            },
            "required": ["task_identifier"]
        }
    )

def register_google_functions(llm, tts):
    """Register Google Tasks functions with LLM"""
    try:
        # Verify authentication works
        service = get_google_tasks_service()
        logger.info("Google Tasks authentication successful")

        # Register functions
        llm.register_function("create_task", create_task_handler, schema=create_task_schema())
        llm.register_function("list_tasks", list_tasks_handler, schema=list_tasks_schema())
        llm.register_function("complete_task", complete_task_handler, schema=complete_task_schema())

        logger.info("Google Tasks functions registered successfully")

    except Exception as e:
        logger.error(f"Failed to register Google Tasks functions: {e}")
        logger.warning("Google Tasks functions will not be available")
```

**2. Update Registration (`functions/__init__.py`):**
```python
def register_all_functions(llm, tts):
    from .home_assistant import register_ha_functions
    from .google_tasks import register_google_functions

    register_ha_functions(llm, tts)
    register_google_functions(llm, tts)

    setup_event_handlers(llm, tts)
```

### Testing Strategy

**Basic Operations:**
1. **Create Task:**
   - "Alex, add buy milk to my tasks" → Task created
   - "Alex, create a task to call mom tomorrow" → Task with note
   - "Alex, remind me to pay rent on the 1st" → Task with due date

2. **List Tasks:**
   - "Alex, what's on my task list?" → Reads first 3 tasks
   - "Alex, show me all my tasks" → Lists up to 10 tasks
   - Empty list → "Your task list is empty"

3. **Complete Tasks:**
   - "Alex, mark task 1 as complete" → First task completed
   - "Alex, complete the buy milk task" → Task found by title
   - Invalid task → "Couldn't find that task"

**Multi-Turn Conversations:**
1. Create task → List tasks → Complete task (all in one conversation)
2. Create 3 tasks → List tasks → Complete by number
3. Ask for tasks → None found → Create one → List again

**Error Cases:**
1. API failure → Graceful error message
2. Authentication expired → Auto-refresh
3. Invalid task identifier → Clear message
4. Network error → Retry logic from Task 003

## Dependencies

### External Dependencies
- Google Tasks API access (from Task 004)
- Valid OAuth token (from Task 004)
- `google-api-python-client` package

### Blocked By
- Task 001 (Function Calling Framework) - needs framework
- Task 004 (Google Tasks OAuth) - needs authentication

### Blocks
- None (independent feature)

## Effort Estimate

- **Size:** M (Medium)
- **Hours:** 8-10 hours
- **Parallel:** false (depends on Task 004)

**Breakdown:**
- Create task handler: 2 hours
- List tasks handler: 2 hours
- Complete task handler: 2 hours
- Function schemas: 1 hour
- Testing and debugging: 2 hours
- Voice response refinement: 1 hour

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Tested with 5+ task operations
- [ ] Multi-turn conversations work smoothly
- [ ] Voice responses are natural and concise
- [ ] Error handling works for all cases
- [ ] Task operations complete in <3 seconds
- [ ] Faster than using Google Tasks app
- [ ] Documentation includes usage examples
- [ ] No console errors during normal operation

## Notes

- **Default Task List:** Use the first task list or '@default' ID
- **Voice Output:** Keep task list summaries concise (first 3 tasks)
- **Task Completion:** Support both number ("task 1") and title ("buy milk")
- **Due Dates:** Optional, keep simple (date only, no time)
- **Future:** Consider adding task editing, deleting, and list management
- **Performance:** Cache task list for short period to reduce API calls
