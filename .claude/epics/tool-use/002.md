---
name: Home Assistant Integration
status: open
created: 2025-10-29T21:30:40Z
updated: 2025-10-29T21:30:40Z
github: null
depends_on: [001]
parallel: false
conflicts_with: []
---

# Task: Home Assistant Integration

## Description

Implement voice-controlled Home Assistant integration for lights and switches. Create async REST API client with authentication, implement control functions with OpenAI schemas, add entity ID mapping configuration, and test with 3-5 real devices.

**Key Outcome:** "Alex, turn off the living room lights" works reliably with voice confirmation.

## Acceptance Criteria

- [ ] `functions/home_assistant.py` created with REST API client
- [ ] `config/ha_entities.json` created with entity ID mappings
- [ ] `.env` updated with `HOME_ASSISTANT_URL` and `HOME_ASSISTANT_TOKEN`
- [ ] Function schemas defined for: `control_light`, `control_switch`, `get_state`
- [ ] Light control works: on/off, brightness (0-255), color (hex)
- [ ] Switch control works: on/off, toggle
- [ ] Device state queries work (e.g., "Is the living room light on?")
- [ ] Entity mapping resolves friendly names to entity IDs
- [ ] Tested with 3-5 real Home Assistant devices
- [ ] Functions registered in `register_all_functions()`
- [ ] Voice feedback confirms actions: "Living room lights are off"

## Technical Details

### Files to Create
1. `pipecat-quickstart/functions/home_assistant.py`
2. `pipecat-quickstart/config/ha_entities.json`

### Files to Modify
1. `pipecat-quickstart/.env` - Add HA credentials
2. `pipecat-quickstart/functions/__init__.py` - Register HA functions
3. `pipecat-quickstart/pyproject.toml` - Add `httpx` dependency

### Implementation Approach

**1. Configuration File (`config/ha_entities.json`):**
```json
{
  "lights": {
    "living_room": "light.living_room_main",
    "bedroom": "light.bedroom_ceiling",
    "kitchen": "light.kitchen_overhead"
  },
  "switches": {
    "porch": "switch.front_porch",
    "fan": "switch.bedroom_fan"
  }
}
```

**2. Environment Variables (`.env`):**
```bash
HOME_ASSISTANT_URL=http://homeassistant.local:8123
HOME_ASSISTANT_TOKEN=eyJ...your_long_lived_token...
```

**3. Home Assistant Client (`functions/home_assistant.py`):**
```python
import httpx
import json
import os
from pathlib import Path
from pipecat.services.openai import FunctionSchema

# Load configuration
CONFIG_PATH = Path(__file__).parent.parent / "config" / "ha_entities.json"
with open(CONFIG_PATH) as f:
    ENTITIES = json.load(f)

HA_URL = os.getenv("HOME_ASSISTANT_URL")
HA_TOKEN = os.getenv("HOME_ASSISTANT_TOKEN")
HA_HEADERS = {
    "Authorization": f"Bearer {HA_TOKEN}",
    "Content-Type": "application/json"
}

def resolve_entity(friendly_name: str, entity_type: str = "lights") -> str:
    """Convert friendly name to entity ID"""
    return ENTITIES.get(entity_type, {}).get(friendly_name, friendly_name)

async def control_light_handler(entity_id: str, action: str, brightness: int = None, color: str = None):
    """Control a light device"""
    # Resolve friendly name
    resolved_id = resolve_entity(entity_id, "lights")

    service = f"light/{action}"
    data = {"entity_id": resolved_id}

    if brightness is not None:
        data["brightness"] = brightness
    if color:
        # Convert hex to RGB tuple
        data["rgb_color"] = tuple(int(color.lstrip('#')[i:i+2], 16) for i in (0, 2, 4))

    async with httpx.AsyncClient(timeout=5.0) as client:
        try:
            response = await client.post(
                f"{HA_URL}/api/services/{service}",
                headers=HA_HEADERS,
                json=data
            )
            response.raise_for_status()
            return {
                "success": True,
                "entity": resolved_id,
                "action": action,
                "message": f"{entity_id} is now {action.replace('turn_', '')}"
            }
        except Exception as e:
            return {
                "success": False,
                "error": str(e),
                "message": f"Failed to control {entity_id}"
            }

async def control_switch_handler(entity_id: str, action: str):
    """Control a switch device"""
    resolved_id = resolve_entity(entity_id, "switches")

    service = f"switch/{action}"
    data = {"entity_id": resolved_id}

    async with httpx.AsyncClient(timeout=5.0) as client:
        try:
            response = await client.post(
                f"{HA_URL}/api/services/{service}",
                headers=HA_HEADERS,
                json=data
            )
            response.raise_for_status()
            return {
                "success": True,
                "entity": resolved_id,
                "action": action
            }
        except Exception as e:
            return {"success": False, "error": str(e)}

async def get_state_handler(entity_id: str):
    """Query device state"""
    async with httpx.AsyncClient(timeout=5.0) as client:
        try:
            response = await client.get(
                f"{HA_URL}/api/states/{entity_id}",
                headers=HA_HEADERS
            )
            response.raise_for_status()
            state = response.json()
            return {
                "success": True,
                "entity": entity_id,
                "state": state.get("state"),
                "attributes": state.get("attributes", {})
            }
        except Exception as e:
            return {"success": False, "error": str(e)}

def create_light_schema():
    return FunctionSchema(
        name="control_light",
        description="Control smart lights (on/off, brightness, color)",
        parameters={
            "type": "object",
            "properties": {
                "entity_id": {
                    "type": "string",
                    "description": "Light entity ID or friendly name (e.g., 'living_room', 'bedroom')"
                },
                "action": {
                    "type": "string",
                    "enum": ["turn_on", "turn_off", "toggle"],
                    "description": "Action to perform"
                },
                "brightness": {
                    "type": "integer",
                    "minimum": 0,
                    "maximum": 255,
                    "description": "Brightness level (0-255), optional"
                },
                "color": {
                    "type": "string",
                    "description": "Hex color code (e.g., '#FF0000' for red), optional"
                }
            },
            "required": ["entity_id", "action"]
        }
    )

def create_switch_schema():
    return FunctionSchema(
        name="control_switch",
        description="Control switches (on/off/toggle)",
        parameters={
            "type": "object",
            "properties": {
                "entity_id": {
                    "type": "string",
                    "description": "Switch entity ID or friendly name"
                },
                "action": {
                    "type": "string",
                    "enum": ["turn_on", "turn_off", "toggle"],
                    "description": "Action to perform"
                }
            },
            "required": ["entity_id", "action"]
        }
    )

def register_ha_functions(llm, tts):
    """Register Home Assistant functions with LLM"""
    llm.register_function("control_light", control_light_handler, schema=create_light_schema())
    llm.register_function("control_switch", control_switch_handler, schema=create_switch_schema())
    llm.register_function("get_state", get_state_handler)
```

**4. Update Function Registration (`functions/__init__.py`):**
```python
def register_all_functions(llm, tts):
    from .home_assistant import register_ha_functions
    register_ha_functions(llm, tts)
    # ... other registrations ...
```

### Testing Strategy

**Prerequisites:**
1. Home Assistant instance running and accessible
2. Generate long-lived access token from HA
3. Add 3-5 test entities to config/ha_entities.json
4. Update .env with HA URL and token

**Manual Tests:**
1. **Light Control:**
   - "Alex, turn on the living room lights" → Lights turn on
   - "Alex, dim the bedroom lights to 50%" → Brightness set to 127
   - "Alex, turn off all lights" → Multiple lights turn off
   - "Alex, set kitchen lights to blue" → Color changes

2. **Switch Control:**
   - "Alex, turn on the porch switch" → Switch activates
   - "Alex, toggle the fan" → Fan state toggles

3. **State Queries:**
   - "Alex, is the living room light on?" → Reports current state

4. **Error Cases:**
   - Home Assistant unreachable → Graceful error message
   - Invalid entity ID → Clear error via voice
   - Network timeout → Retry or fail gracefully

## Dependencies

### External Dependencies
- Home Assistant instance (local or VPN-accessible)
- Long-lived access token from Home Assistant
- Entity IDs for target devices
- `httpx` Python package (add to pyproject.toml)

### Blocked By
- Task 001 (Function Calling Framework Setup) - must be complete

### Blocks
- Task 003 (Error Handling & Configuration) - needs this working first

## Effort Estimate

- **Size:** M (Medium)
- **Hours:** 8-12 hours
- **Parallel:** false (depends on Task 001)

**Breakdown:**
- REST API client implementation: 3 hours
- Function schemas and handlers: 3 hours
- Configuration system: 2 hours
- Testing with real devices: 3 hours
- Debugging and refinement: 1 hour

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Tested with 3-5 real Home Assistant devices
- [ ] Voice commands complete in <3 seconds
- [ ] Success rate >95% when HA is available
- [ ] Errors handled gracefully (service down, invalid entity)
- [ ] Voice confirmations are natural and accurate
- [ ] Entity mapping works for friendly names
- [ ] No console errors during normal operation
- [ ] Configuration documented in README

## Notes

- **Security:** Store token in .env, never commit to git
- **Entity Discovery:** User must manually add entities to config (no auto-discovery yet)
- **Friendly Names:** Support both friendly names ("living room") and entity IDs ("light.living_room")
- **Performance:** 5 second timeout for API calls
- **Future:** Consider supporting scenes, automations, and groups
