---
name: Function Calling Framework Setup
status: open
created: 2025-10-29T21:30:40Z
updated: 2025-10-29T21:54:09Z
github: https://github.com/zach-fau/home-assistant/issues/12
depends_on: []
parallel: false
conflicts_with: []
---

# Task: Function Calling Framework Setup

## Description

Set up the foundational function calling infrastructure in the pipecat-quickstart project. Create the `functions/` module structure, implement the registration system, add event handlers for voice feedback, and integrate with bot.py. This is the foundational task that enables all other tool integrations.

**Key Outcome:** Alex can register and execute functions via OpenAI function calling, with immediate voice feedback during execution.

## Acceptance Criteria

- [ ] `functions/` directory created with proper module structure
- [ ] `functions/__init__.py` implements `register_all_functions(llm, tts)` coordinator
- [ ] `functions/schemas.py` created for shared function schema definitions
- [ ] Event handlers implemented: `on_function_calls_started`, `on_function_calls_completed`, `on_function_calls_failed`
- [ ] bot.py modified to call `register_all_functions()` during initialization
- [ ] Test with a mock function (e.g., "echo") to verify end-to-end flow
- [ ] Voice feedback works: LLM generates dynamic acknowledgments during function execution
- [ ] No errors or warnings in console output

## Technical Details

### Files to Create
1. `pipecat-quickstart/functions/__init__.py`
2. `pipecat-quickstart/functions/schemas.py`
3. `pipecat-quickstart/functions/utils.py` (optional, for shared HTTP client)

### Files to Modify
1. `pipecat-quickstart/bot.py` - Add function registration call

### Implementation Approach

**1. Create Module Structure:**
```python
# functions/__init__.py
from pipecat.services.openai import OpenAILLMService

def register_all_functions(llm: OpenAILLMService, tts):
    """
    Register all available functions with the LLM.
    Called once during bot initialization.
    """
    # Import and register each integration
    # from .home_assistant import register_ha_functions
    # register_ha_functions(llm, tts)

    # For now, register a test function
    from .schemas import create_echo_schema
    llm.register_function("echo", echo_handler, schema=create_echo_schema())

    # Set up event handlers
    setup_event_handlers(llm, tts)

async def echo_handler(text: str):
    """Test function to verify framework works"""
    return {"message": f"Echo: {text}"}

def setup_event_handlers(llm, tts):
    """Configure function call lifecycle event handlers"""

    @llm.event_handler("on_function_calls_started")
    async def on_function_start(service, function_calls):
        # LLM automatically generates varied acknowledgments
        # Examples: "Sure, let me check...", "On it!", "Give me a moment..."
        pass

    @llm.event_handler("on_function_calls_completed")
    async def on_function_complete(service, results):
        # LLM receives results and generates natural response
        pass

    @llm.event_handler("on_function_calls_failed")
    async def on_function_error(service, error):
        # Generate friendly error message via voice
        await tts.queue_frame(TTSSpeakFrame(
            "Sorry, something went wrong. Let me know if you'd like me to try again."
        ))
```

**2. Create Schema Helper:**
```python
# functions/schemas.py
from pipecat.services.openai import FunctionSchema

def create_echo_schema():
    """Test function schema"""
    return FunctionSchema(
        name="echo",
        description="Echo back the provided text (test function)",
        parameters={
            "type": "object",
            "properties": {
                "text": {
                    "type": "string",
                    "description": "Text to echo back"
                }
            },
            "required": ["text"]
        }
    )
```

**3. Modify bot.py:**
```python
# In bot.py, after LLM and TTS are initialized:
from functions import register_all_functions

# ... existing code ...

llm = OpenAILLMService(api_key=os.getenv("OPENAI_API_KEY"))
tts = CartesiaTTSService(...)

# Register all functions
register_all_functions(llm, tts)
```

### Testing Strategy

**Manual Test:**
1. Start bot: `python bot.py`
2. Say: "Alex, echo hello world"
3. Verify:
   - Immediate acknowledgment (< 1 sec): "Sure..." or similar
   - Function executes
   - Alex responds with: "Echo: hello world"
4. Test error case: Modify echo_handler to raise exception, verify error message

**Success Indicators:**
- No import errors
- Function registration succeeds
- Voice pipeline doesn't break during function call
- Dynamic acknowledgments work (varied responses)

## Dependencies

### External Dependencies
- Pipecat 0.0.91+ (already installed)
- OpenAI API configured (already done)
- Existing bot.py with working voice pipeline

### Blocked By
- None (this is the foundational task)

### Blocks
- Task 002 (Home Assistant Integration)
- Task 004 (Google Tasks OAuth)
- Task 006 (Web Search Integration)

## Effort Estimate

- **Size:** S (Small)
- **Hours:** 4-6 hours
- **Parallel:** false (foundational task, must complete first)

**Breakdown:**
- Create module structure: 1 hour
- Implement registration system: 1 hour
- Add event handlers: 2 hours
- Modify bot.py: 0.5 hours
- Testing and debugging: 1.5 hours

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Code follows existing pipecat-quickstart patterns
- [ ] Test function (echo) works end-to-end
- [ ] Voice feedback is immediate and natural
- [ ] No console errors or warnings
- [ ] bot.py successfully imports and registers functions
- [ ] Ready for integration tasks (002, 004, 006) to add real functions
- [ ] Basic error handling works (failed functions don't crash bot)

## Notes

- Reference Pipecat example: `examples/foundational/14-function-calling.py`
- Keep event handlers simple initially - LLM generates dynamic feedback automatically
- Don't overcomplicate - leverage Pipecat's existing infrastructure
- The echo function is temporary scaffolding - will be removed once real integrations are added
