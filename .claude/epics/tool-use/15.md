---
name: Google Tasks OAuth Setup
status: open
created: 2025-10-29T21:30:40Z
updated: 2025-10-29T21:54:09Z
github: https://github.com/zach-fau/home-assistant/issues/15
depends_on: [12]
parallel: true
conflicts_with: []
---

# Task: Google Tasks OAuth Setup

## Description

Set up Google Cloud Project with Tasks API enabled, implement OAuth 2.0 authentication flow, create token storage and refresh mechanism, and test authentication end-to-end. This establishes the foundation for Task 005 (Google Tasks operations).

**Key Outcome:** OAuth flow works, tokens are stored securely and refresh automatically, ready for task operations.

## Acceptance Criteria

- [ ] Google Cloud Project created with Tasks API enabled
- [ ] OAuth 2.0 credentials obtained (client ID and secret)
- [ ] `credentials.json` stored in config directory (gitignored)
- [ ] OAuth flow implemented for initial authorization
- [ ] Token storage implemented (`token.json` in config, gitignored)
- [ ] Token refresh logic implemented (auto-refresh before expiry)
- [ ] `.env` updated with Google API credentials
- [ ] `google_tasks.py` module created with auth helper
- [ ] Dependencies added to pyproject.toml
- [ ] Successful authentication tested manually
- [ ] Token refresh tested (force expiry and verify refresh)

## Technical Details

### Files to Create
1. `pipecat-quickstart/functions/google_tasks.py` - OAuth and task functions
2. `pipecat-quickstart/config/credentials.json` - OAuth credentials (gitignored)
3. `pipecat-quickstart/config/token.json` - Stored tokens (gitignored, auto-created)

### Files to Modify
1. `pipecat-quickstart/.env` - Add Google credentials
2. `pipecat-quickstart/.gitignore` - Ignore credentials and tokens
3. `pipecat-quickstart/pyproject.toml` - Add Google API dependencies
4. `pipecat-quickstart/config/.gitignore` - Protect sensitive files

### Implementation Approach

**1. Google Cloud Setup (Manual Steps):**

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create new project (e.g., "Alex Voice Assistant")
3. Enable Google Tasks API:
   - APIs & Services → Library
   - Search "Google Tasks API"
   - Click Enable
4. Create OAuth 2.0 Credentials:
   - APIs & Services → Credentials
   - Create Credentials → OAuth client ID
   - Application type: Desktop app
   - Name: "Alex Desktop Client"
   - Download credentials → Save as `config/credentials.json`
5. Add test user (if in testing mode):
   - OAuth consent screen → Test users → Add your email

**2. Dependencies (`pyproject.toml`):**
```toml
[tool.poetry.dependencies]
google-api-python-client = "^2.110.0"
google-auth-httplib2 = "^0.2.0"
google-auth-oauthlib = "^1.2.0"
```

**3. OAuth Implementation (`functions/google_tasks.py`):**
```python
import os
import json
from pathlib import Path
from google.auth.transport.requests import Request
from google.oauth2.credentials import Credentials
from google_auth_oauthlib.flow import InstalledAppFlow
from googleapiclient.discovery import build
from googleapiclient.errors import HttpError
import logging

logger = logging.getLogger(__name__)

# Google Tasks API scope
SCOPES = ['https://www.googleapis.com/auth/tasks']

# Paths
CONFIG_DIR = Path(__file__).parent.parent / "config"
CREDENTIALS_FILE = CONFIG_DIR / "credentials.json"
TOKEN_FILE = CONFIG_DIR / "token.json"

def get_google_tasks_service():
    """
    Get authenticated Google Tasks service.
    Handles OAuth flow, token storage, and refresh.

    Returns:
        Resource: Google Tasks API service object
    """
    creds = None

    # Load existing token if available
    if TOKEN_FILE.exists():
        try:
            creds = Credentials.from_authorized_user_file(str(TOKEN_FILE), SCOPES)
            logger.debug("Loaded existing credentials from token.json")
        except Exception as e:
            logger.warning(f"Failed to load existing token: {e}")
            creds = None

    # If no valid credentials, authenticate
    if not creds or not creds.valid:
        if creds and creds.expired and creds.refresh_token:
            # Refresh expired token
            try:
                logger.info("Refreshing expired Google API token...")
                creds.refresh(Request())
                logger.info("Token refreshed successfully")
            except Exception as e:
                logger.error(f"Failed to refresh token: {e}")
                creds = None

        if not creds:
            # Run OAuth flow
            if not CREDENTIALS_FILE.exists():
                raise FileNotFoundError(
                    f"Credentials file not found: {CREDENTIALS_FILE}\n"
                    "Please download OAuth credentials from Google Cloud Console"
                )

            logger.info("Starting OAuth flow...")
            flow = InstalledAppFlow.from_client_secrets_file(
                str(CREDENTIALS_FILE),
                SCOPES
            )
            # Run local server flow
            creds = flow.run_local_server(port=0)
            logger.info("OAuth flow completed successfully")

        # Save credentials for next run
        with open(TOKEN_FILE, 'w') as token:
            token.write(creds.to_json())
            logger.info(f"Saved credentials to {TOKEN_FILE}")

    try:
        service = build('tasks', 'v1', credentials=creds)
        logger.debug("Google Tasks service initialized")
        return service
    except HttpError as error:
        logger.error(f"Failed to build Google Tasks service: {error}")
        raise

def test_authentication():
    """
    Test function to verify OAuth works.
    Lists task lists to confirm access.
    """
    try:
        service = get_google_tasks_service()
        results = service.tasklists().list(maxResults=10).execute()
        lists = results.get('items', [])

        if not lists:
            print('No task lists found.')
            return False

        print('Task lists:')
        for task_list in lists:
            print(f"  - {task_list['title']} (ID: {task_list['id']})")

        return True
    except Exception as e:
        print(f"Authentication failed: {e}")
        return False

def register_google_functions(llm, tts):
    """
    Register Google Tasks functions with LLM.
    Will be implemented in Task 005.
    """
    # Verify authentication works on startup
    try:
        service = get_google_tasks_service()
        logger.info("Google Tasks authentication successful")
    except Exception as e:
        logger.error(f"Google Tasks authentication failed: {e}")
        logger.warning("Google Tasks functions will not be available")

    # Function registration will be added in Task 005
    pass
```

**4. Update .gitignore:**
```gitignore
# Google OAuth
config/credentials.json
config/token.json

# Environment
.env
```

**5. Test Script (for manual verification):**
```python
# test_google_auth.py
if __name__ == "__main__":
    from functions.google_tasks import test_authentication
    import logging

    logging.basicConfig(level=logging.DEBUG)

    print("Testing Google Tasks authentication...")
    if test_authentication():
        print("\n✅ Authentication successful!")
    else:
        print("\n❌ Authentication failed")
```

### Testing Strategy

**Initial Setup Test:**
1. Install dependencies: `poetry install`
2. Place credentials.json in config/
3. Run test script: `python test_google_auth.py`
4. Browser opens for OAuth consent
5. Authorize the application
6. Verify token.json created
7. Verify task lists are displayed

**Token Refresh Test:**
1. Manually edit token.json to set expiry to past date
2. Run test script again
3. Verify token refreshes without re-auth
4. Verify new token.json has valid expiry

**Error Cases:**
1. Missing credentials.json → Clear error message
2. Invalid credentials → OAuth flow fails gracefully
3. Network error during refresh → Retry or fail with message
4. User denies consent → Clear error message

## Dependencies

### External Dependencies
- Google Cloud Platform account (free tier sufficient)
- Google Tasks API enabled in GCP project
- OAuth 2.0 credentials (client ID and secret)
- Browser for OAuth consent flow
- Python packages: google-api-python-client, google-auth-*

### Blocked By
- Task 001 (Function Calling Framework) - needs basic structure

### Blocks
- Task 005 (Google Tasks Operations) - needs authentication working

## Effort Estimate

- **Size:** M (Medium)
- **Hours:** 6-8 hours
- **Parallel:** true (can work on this while Task 002 is in progress)

**Breakdown:**
- Google Cloud setup: 1.5 hours
- OAuth flow implementation: 2 hours
- Token storage and refresh: 1.5 hours
- Testing and debugging: 2 hours
- Documentation: 1 hour

## Definition of Done

- [ ] All acceptance criteria met
- [ ] OAuth flow works end-to-end in browser
- [ ] Token storage works (persists across restarts)
- [ ] Token refresh works automatically
- [ ] Test script successfully lists task lists
- [ ] Credentials and tokens are gitignored
- [ ] Documentation includes GCP setup instructions
- [ ] Error handling for missing/invalid credentials
- [ ] Ready for Task 005 to implement task operations

## Notes

- **Security:** Never commit credentials.json or token.json to git
- **OAuth Consent:** If app is in "Testing" mode, only test users can authenticate
- **Token Expiry:** Tokens typically last 1 hour, refresh tokens are long-lived
- **Browser:** OAuth flow requires browser access (can't run headless initially)
- **First Run:** User will need to authorize once, subsequent runs use stored token
- **Scopes:** Using minimum scope (tasks) - can expand later for Calendar, etc.
- **Reference:** [Google Tasks API Python Quickstart](https://developers.google.com/tasks/quickstart/python)
