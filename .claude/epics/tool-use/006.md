---
name: Tavily Web Search Integration
status: open
created: 2025-10-29T21:30:40Z
updated: 2025-10-29T21:30:40Z
github: null
depends_on: [001]
parallel: true
conflicts_with: []
---

# Task: Tavily Web Search Integration

## Description

Integrate Tavily Search API for voice-activated web search with LLM-optimized results. Implement search function with result extraction, format results for natural voice summarization, and test with various query types.

**Key Outcome:** "Alex, search for best coffee shops nearby" returns summarized results in <2 seconds with natural voice response.

## Acceptance Criteria

- [ ] Tavily API account created with API key
- [ ] `.env` updated with `TAVILY_API_KEY`
- [ ] `functions/web_search.py` created with search handler
- [ ] Function schema defined for `web_search`
- [ ] Search returns top 3-5 results from Tavily
- [ ] Results formatted for LLM summarization
- [ ] Response time <2 seconds for typical queries
- [ ] Voice responses are natural and concise
- [ ] Error handling for API failures and rate limits
- [ ] Function registered in `register_all_functions()`
- [ ] Tested with 5+ different query types

## Technical Details

### Files to Create
1. `pipecat-quickstart/functions/web_search.py` - Tavily search integration

### Files to Modify
1. `pipecat-quickstart/.env` - Add Tavily API key
2. `pipecat-quickstart/functions/__init__.py` - Register search function
3. `pipecat-quickstart/pyproject.toml` - Add httpx if not already present

### Implementation Approach

**1. Tavily Setup:**
- Sign up at [Tavily.com](https://tavily.com/)
- Get API key from dashboard
- Free tier: 1,000 searches/month

**2. Web Search Handler (`functions/web_search.py`):**
```python
import httpx
import os
import logging
from pipecat.services.openai import FunctionSchema
from typing import Optional, List, Dict

logger = logging.getLogger(__name__)

TAVILY_API_KEY = os.getenv("TAVILY_API_KEY")
TAVILY_API_URL = "https://api.tavily.com/search"

async def web_search_handler(
    query: str,
    num_results: int = 3,
    search_depth: str = "basic"
):
    """
    Search the web using Tavily API

    Args:
        query: Search query
        num_results: Number of results to return (1-10, default 3)
        search_depth: 'basic' (faster) or 'advanced' (more comprehensive)

    Returns:
        Dict with search results formatted for LLM
    """
    if not TAVILY_API_KEY:
        logger.error("TAVILY_API_KEY not set in .env")
        return {
            "success": False,
            "error": "Tavily API key not configured",
            "message": "Sorry, web search isn't configured yet"
        }

    try:
        async with httpx.AsyncClient(timeout=10.0) as client:
            response = await client.post(
                TAVILY_API_URL,
                json={
                    "api_key": TAVILY_API_KEY,
                    "query": query,
                    "max_results": num_results,
                    "search_depth": search_depth,
                    "include_answer": True,  # Get AI-generated answer
                    "include_raw_content": False,  # Don't need full HTML
                    "include_domains": [],  # No domain restrictions
                    "exclude_domains": []
                }
            )
            response.raise_for_status()
            data = response.json()

            # Extract results
            results = data.get("results", [])
            answer = data.get("answer", "")

            if not results and not answer:
                return {
                    "success": True,
                    "query": query,
                    "answer": "",
                    "results": [],
                    "message": f"I couldn't find any results for '{query}'"
                }

            # Format results for LLM
            formatted_results = []
            for i, result in enumerate(results[:num_results], 1):
                formatted_results.append({
                    "number": i,
                    "title": result.get("title", ""),
                    "url": result.get("url", ""),
                    "content": result.get("content", ""),
                    "score": result.get("score", 0)
                })

            # Create summary for LLM
            summary_parts = []

            if answer:
                summary_parts.append(f"Quick answer: {answer}")

            if formatted_results:
                summary_parts.append(f"Found {len(formatted_results)} results:")
                for r in formatted_results:
                    summary_parts.append(f"{r['number']}. {r['title']} - {r['content'][:150]}...")

            summary = " ".join(summary_parts)

            logger.info(f"Web search for '{query}': {len(results)} results")

            return {
                "success": True,
                "query": query,
                "answer": answer,
                "results": formatted_results,
                "summary": summary,
                "message": summary  # LLM will paraphrase this
            }

    except httpx.HTTPStatusError as e:
        if e.response.status_code == 429:
            logger.warning("Tavily rate limit exceeded")
            return {
                "success": False,
                "error": "Rate limit exceeded",
                "message": "I've hit the search limit. Please try again in a moment."
            }
        elif e.response.status_code == 401:
            logger.error("Tavily API authentication failed")
            return {
                "success": False,
                "error": "Authentication failed",
                "message": "Web search authentication failed. Please check the API key."
            }
        else:
            logger.error(f"Tavily API error: {e}")
            return {
                "success": False,
                "error": str(e),
                "message": "Sorry, the search service had an error"
            }

    except httpx.TimeoutException:
        logger.warning(f"Tavily search timeout for query: {query}")
        return {
            "success": False,
            "error": "Timeout",
            "message": "The search took too long. Please try again."
        }

    except Exception as e:
        logger.exception(f"Unexpected error in web search")
        return {
            "success": False,
            "error": str(e),
            "message": "Sorry, something went wrong with the search"
        }

def create_search_schema():
    """Create function schema for web search"""
    return FunctionSchema(
        name="web_search",
        description="Search the web for information, news, or answers to questions. Returns top search results with summaries.",
        parameters={
            "type": "object",
            "properties": {
                "query": {
                    "type": "string",
                    "description": "Search query (e.g., 'best coffee shops in Seattle', 'what is quantum computing')"
                },
                "num_results": {
                    "type": "integer",
                    "description": "Number of results to return (1-5, default 3)",
                    "minimum": 1,
                    "maximum": 5,
                    "default": 3
                },
                "search_depth": {
                    "type": "string",
                    "enum": ["basic", "advanced"],
                    "description": "Search depth: 'basic' (faster) or 'advanced' (more thorough)",
                    "default": "basic"
                }
            },
            "required": ["query"]
        }
    )

def register_search_functions(llm, tts):
    """Register web search functions with LLM"""
    if not TAVILY_API_KEY:
        logger.warning("TAVILY_API_KEY not set, web search will not be available")
        return

    llm.register_function(
        "web_search",
        web_search_handler,
        schema=create_search_schema()
    )

    logger.info("Web search functions registered successfully")
```

**3. Update .env:**
```bash
TAVILY_API_KEY=tvly-your-api-key-here
```

**4. Register Function (`functions/__init__.py`):**
```python
def register_all_functions(llm, tts):
    from .home_assistant import register_ha_functions
    from .google_tasks import register_google_functions
    from .web_search import register_search_functions

    register_ha_functions(llm, tts)
    register_google_functions(llm, tts)
    register_search_functions(llm, tts)

    setup_event_handlers(llm, tts)
```

### Testing Strategy

**Query Types to Test:**

1. **Factual Questions:**
   - "What is the capital of Japan?"
   - "Who won the 2023 World Series?"
   - "When was Python created?"

2. **Local Search:**
   - "Best coffee shops near me"
   - "Top rated restaurants in Seattle"
   - Note: May need location context

3. **How-To Questions:**
   - "How to make sourdough bread"
   - "How to fix a leaky faucet"

4. **Current Events:**
   - "Latest news on AI"
   - "Weather forecast for tomorrow"

5. **Comparison:**
   - "Difference between Python and JavaScript"
   - "Best laptop for programming"

**Expected Behavior:**
- Search completes in <2 seconds
- LLM summarizes results naturally
- If Tavily returns AI answer, it's included
- Results are relevant and useful
- Voice response is concise (not reading full URLs)

**Error Cases:**
1. Invalid API key → Clear error message
2. Rate limit exceeded → Helpful message to wait
3. Network timeout → Retry or fail gracefully
4. No results found → "Couldn't find results for..."
5. Empty query → LLM should handle validation

## Dependencies

### External Dependencies
- Tavily API account (free tier sufficient)
- Tavily API key
- Internet connection for API calls
- httpx for async HTTP requests

### Blocked By
- Task 001 (Function Calling Framework) - needs framework

### Blocks
- None (independent feature)

## Effort Estimate

- **Size:** S (Small)
- **Hours:** 4-6 hours
- **Parallel:** true (can work on this independently)

**Breakdown:**
- Tavily API setup: 0.5 hours
- Search handler implementation: 2 hours
- Function schema: 0.5 hours
- Error handling: 1 hour
- Testing with various queries: 1.5 hours
- Voice response refinement: 0.5 hours

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Tested with 5+ different query types
- [ ] Response time <2 seconds for basic searches
- [ ] Voice summaries are natural and concise
- [ ] Error handling works for all cases
- [ ] Rate limits handled gracefully
- [ ] No console errors during normal operation
- [ ] Tavily free tier usage stays under limit
- [ ] Documentation includes example queries

## Notes

- **Tavily Benefits:** LLM-optimized results, includes AI-generated answers, faster than Playwright
- **Search Depth:** Use 'basic' by default (faster), 'advanced' only when needed
- **Result Limits:** Keep num_results low (3-5) to fit in voice response
- **Location:** Tavily may not have location context - clarify in query if needed
- **Cost:** Free tier is 1,000 searches/month, should be sufficient for personal use
- **Caching:** Consider caching frequent queries to reduce API usage
- **Future:** Could add image search, news search, or domain filtering
- **Alternative:** If Tavily doesn't work, could fallback to SerpAPI or similar
