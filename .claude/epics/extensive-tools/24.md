---
name: Timer/Alarm System (APScheduler)
status: open
created: 2025-10-30T22:18:30Z
updated: 2025-10-30T22:18:30Z
github: null
depends_on: [1]
parallel: true
conflicts_with: []
---

# Task 003: Timer/Alarm System (APScheduler)

## Overview

Implement timer and alarm system using APScheduler. Support multiple concurrent timers with names, recurring alarms, and optional Home Assistant integration for alarm triggers.

**Effort**: 4 hours (S)
**Dependencies**: [001] (needs config system)
**Parallel**: true (can run alongside Task 002)

## Description

This task implements a comprehensive timer and alarm system using the APScheduler library. Users can set multiple named timers, create one-time or recurring alarms, and optionally integrate with Home Assistant to trigger lights, scenes, or automations when alarms go off.

This provides critical daily functionality for cooking timers, reminders, wake-up alarms, and scheduled notifications.

## Acceptance Criteria

- [ ] `functions/timer_alarm.py` created with APScheduler
- [ ] Timer handlers: set timer, check timer, cancel timer
- [ ] Named timers support ("timer for the chicken")
- [ ] Multiple concurrent timers
- [ ] Alarm handlers: set alarm, recurring alarms (weekday/weekend), snooze
- [ ] Optional: Home Assistant integration (trigger lights/scenes on alarm)
- [ ] Distinct sounds/notifications for timers vs alarms
- [ ] Function schemas for timer and alarm functions
- [ ] All functions registered in `functions/__init__.py`
- [ ] Voice commands working: "Set a timer for 10 minutes", "Wake me up at 7am"

## Files Created/Modified

**New Files**:
- `functions/timer_alarm.py` - APScheduler-based timer and alarm system

**Modified Files**:
- `functions/__init__.py` - Register timer/alarm functions
- `requirements.txt` - Add `apscheduler` dependency
- `config/briefing_config.yaml` - Add timer/alarm configuration (optional)

## Technical Details

### Timer Functions

1. `set_timer(duration_minutes: int, name: str = None)` - Set a timer
2. `check_timer(name: str = None)` - Check remaining time on timer
3. `cancel_timer(name: str = None)` - Cancel a timer
4. `list_timers()` - List all active timers

### Alarm Functions

5. `set_alarm(time: str, date: str = None, recurring: str = None)` - Set alarm
   - `time`: "07:00", "7:30 AM", etc.
   - `date`: "2025-10-31" or null for next occurrence
   - `recurring`: "weekday", "weekend", "daily", "weekly", or null
6. `list_alarms()` - List all active alarms
7. `snooze_alarm(alarm_id: str, minutes: int = 10)` - Snooze alarm
8. `cancel_alarm(alarm_id: str)` - Delete alarm

### APScheduler Setup

```python
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.date import DateTrigger
from apscheduler.triggers.cron import CronTrigger

class TimerAlarmManager:
    def __init__(self, tts, home_assistant_client=None):
        self.scheduler = AsyncIOScheduler()
        self.tts = tts
        self.ha_client = home_assistant_client
        self.timers = {}  # Track active timers
        self.scheduler.start()

    async def timer_callback(self, timer_name: str):
        """Called when timer expires."""
        await self.tts.queue_frame(TTSSpeakFrame(
            f"Timer{' for ' + timer_name if timer_name else ''} is done!"
        ))
        # Play timer sound
        del self.timers[timer_name or "default"]

    async def alarm_callback(self, alarm_id: str, alarm_name: str):
        """Called when alarm triggers."""
        await self.tts.queue_frame(TTSSpeakFrame(
            f"Good morning! It's time to wake up. {alarm_name}"
        ))
        # Play alarm sound

        # Optional: Trigger Home Assistant scene
        if self.ha_client:
            await self.ha_client.trigger_scene("morning_alarm")
```

### Named Timers

Support natural language timer names:
- "Set a timer for 20 minutes" → Unnamed timer
- "Set a timer for the chicken for 45 minutes" → Named "chicken"
- "Check the chicken timer" → Query named timer
- "Cancel all timers" → Cancel all active timers

### Recurring Alarms

Support patterns:
- `weekday`: Monday-Friday
- `weekend`: Saturday-Sunday
- `daily`: Every day
- `weekly`: Same day of week
- Specific days: "Monday,Wednesday,Friday"

### Home Assistant Integration (Optional)

If `home_assistant_client` is available and configured:
- Trigger scene on alarm: lights fade in, adjust temperature
- Trigger automation: start coffee maker, open blinds
- Configurable per alarm: `ha_scene` parameter

## Dependencies

**External**:
- APScheduler library
- Optional: Home Assistant API (if integration enabled)

**Internal**:
- Task 001 (configuration system)
- Existing TTS infrastructure (`tts.queue_frame()`)
- Optional: `home_assistant.py` client (if exists)

## Testing Checklist

- [ ] APScheduler initializes correctly
- [ ] Set timer function works
- [ ] Named timers work correctly
- [ ] Multiple concurrent timers supported
- [ ] Timer expiration triggers TTS callback
- [ ] Check timer returns correct remaining time
- [ ] Cancel timer removes from scheduler
- [ ] Set alarm function works (one-time)
- [ ] Recurring alarms work (weekday, weekend, daily)
- [ ] Alarm expiration triggers TTS callback
- [ ] Snooze alarm delays correctly
- [ ] List timers/alarms returns correct data
- [ ] Home Assistant integration works (if configured)
- [ ] Distinct sounds for timer vs alarm
- [ ] Error handling for invalid time formats
- [ ] Scheduler persists across restarts (if needed)

## Notes

- Can be implemented in parallel with Task 002
- Scheduler runs in-memory by default (no database needed for MVP)
- For persistence across restarts, can add JobStore later
- Timer sounds and alarm sounds should be distinct (timer: ding, alarm: gradual)
- Consider implementing gentle wake-up (sound fade-in) for alarms
- Home Assistant integration is optional but enhances UX significantly
- Follow existing patterns from other integrations for consistency
- Test with system clock changes and timezone handling
