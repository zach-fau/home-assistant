---
name: Morning Briefing Core (Manager + Scheduler)
status: open
created: 2025-10-30T22:18:30Z
updated: 2025-10-30T22:18:30Z
github: null
depends_on: [001, 002, 004]
parallel: false
conflicts_with: []
---

# Task 005: Morning Briefing Core (Manager + Scheduler)

## Metadata

- **Effort**: 8 hours (M)
- **Phase**: Phase 2 - News + Briefing MVP
- **Dependencies**: Tasks 001 (config), 002 (Google services), 004 (news)
- **Parallel**: No (foundational for Task 006)
- **Conflicts**: None

## Description

Build morning briefing orchestration system with parallel data fetching, scheduler, and voice trigger. Combines weather, calendar, email, tasks, and news into cohesive spoken briefing.

## Context

This task implements the core morning briefing system (AD3 - Briefing as Orchestration Layer). The briefing manager calls existing integration functions in parallel using `asyncio.gather()` to meet the <30 second performance requirement. It includes both scheduled delivery (7:00 AM) and voice-triggered delivery ("Good morning").

## Technical Approach

**Architecture**:
- `briefing/manager.py` - BriefingManager class orchestrating parallel API calls
- `briefing/config.py` - Load and validate YAML briefing settings
- `briefing/scheduler.py` - APScheduler for scheduled delivery
- Parallel data fetching using `asyncio.gather()` for performance
- Graceful degradation (if one service fails, others continue)
- Timeout per API call (5s max)

**Data Flow**:
```
Voice: "Good morning" OR Scheduled: 7:00 AM
  ↓
BriefingManager.generate_briefing()
  ↓
asyncio.gather([
  fetch_weather(),
  fetch_calendar(),
  fetch_email(),
  fetch_tasks(),
  fetch_news(),
  fetch_packages()
])
  ↓
Format cohesive narrative (2-3 minutes of speech)
  ↓
TTS queue
  ↓
User hears briefing
```

**Narrative Format**:
- Greeting (time-aware: morning/afternoon)
- Weather summary with recommendations
- Calendar overview (next 3-5 events)
- Email highlights (unread count, urgent items)
- Task summary (due today, overdue)
- News headlines (top 2-3 stories)
- Package updates (if any in transit)
- Closing remarks

## Acceptance Criteria

- [ ] `functions/briefing/` directory created
- [ ] `briefing/manager.py` with BriefingManager class
- [ ] Parallel data fetching using `asyncio.gather()`
- [ ] `briefing/config.py` for loading YAML briefing settings
- [ ] `briefing/scheduler.py` with APScheduler for scheduled delivery
- [ ] Voice command trigger: "Good morning", "Give me my briefing"
- [ ] Scheduled delivery at configured time (default 7:00 AM)
- [ ] Format briefing narrative (2-3 minutes of speech)
- [ ] Graceful degradation (if one service fails, others continue)
- [ ] Timeouts per API call (5s max)
- [ ] Briefing function registered in `functions/__init__.py`
- [ ] End-to-end briefing working with all components

## Files Created/Modified

### New Files
- `functions/briefing/__init__.py` - Package initialization
- `functions/briefing/manager.py` - BriefingManager class
- `functions/briefing/config.py` - Configuration loading
- `functions/briefing/scheduler.py` - Scheduler setup

### Modified Files
- `functions/__init__.py` - Register briefing function
- `config/briefing_config.yaml` - Briefing settings (if not exists from Task 001)

## Testing

**Manual Testing**:
1. Voice command: "Good morning" → Verify briefing plays
2. Voice command: "Give me my briefing" → Verify briefing plays
3. Scheduled trigger: Set time 1 minute ahead, wait, verify briefing plays
4. Performance: Measure total briefing generation time (<30 seconds)
5. Graceful degradation: Disable one API (e.g., news), verify briefing still works

**Integration Testing**:
- Verify all data sources fetched in parallel
- Test with all components enabled
- Test with some components disabled in config
- Verify timeout handling (mock slow API)
- Test scheduler persistence across restarts

## Dependencies

**External**:
- APScheduler library (`pip install apscheduler`)

**Internal**:
- Task 001 (configuration system)
- Task 002 (Google services for calendar, email, tasks)
- Task 004 (news integration)
- Weather integration (from Task 001)

## Implementation Notes

**BriefingManager Class**:
```python
class BriefingManager:
    def __init__(self, config, llm, tts):
        self.config = config
        self.llm = llm
        self.tts = tts

    async def generate_briefing(self) -> dict:
        """Fetch data from all enabled services in parallel."""
        tasks = []
        if self.config.weather_enabled:
            tasks.append(asyncio.wait_for(self._fetch_weather(), timeout=5.0))
        if self.config.calendar_enabled:
            tasks.append(asyncio.wait_for(self._fetch_calendar(), timeout=5.0))
        # ... other services

        results = await asyncio.gather(*tasks, return_exceptions=True)
        return self._format_briefing(results)

    async def deliver_briefing(self):
        """Generate and speak briefing."""
        briefing_data = await self.generate_briefing()
        briefing_text = self._format_narrative(briefing_data)
        await self.tts.queue_frame(TTSSpeakFrame(briefing_text))
```

**Scheduler Setup**:
```python
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.cron import CronTrigger

scheduler = AsyncIOScheduler()
scheduler.add_job(
    briefing_manager.deliver_briefing,
    CronTrigger(hour=7, minute=0),
    id='morning_briefing'
)
scheduler.start()
```

**Error Handling**:
- Use `return_exceptions=True` in `asyncio.gather()` to capture failures
- Log errors but continue with available data
- Include fallback messages if critical components fail

## Success Metrics

- Briefing completes in <30 seconds (NFR1.1)
- All enabled components fetched in parallel
- Graceful degradation works (partial data acceptable)
- Scheduled delivery executes at configured time
- Voice trigger responds immediately
- Narrative is cohesive and natural-sounding (2-3 minutes when spoken)

## Future Enhancements (Not in This Task)

- Skip functionality (Task 006)
- Weekday vs weekend templates (Task 006)
- Context-aware adaptations (Task 006)
