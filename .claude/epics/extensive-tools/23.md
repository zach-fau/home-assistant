---
name: Google Services Bundle (Calendar, Gmail, Keep, Fit)
status: open
created: 2025-10-30T22:18:30Z
updated: 2025-10-30T22:18:30Z
github: null
depends_on: [1]
parallel: false
conflicts_with: []
---

# Task 002: Google Services Bundle (Calendar, Gmail, Keep, Fit)

## Overview

Extend `google_auth.py` to support 4 Google APIs and implement unified `functions/google_services.py` module with handlers for Calendar (events), Gmail (email), Keep (notes), and Fit (fitness tracking). Leverage existing OAuth infrastructure.

**Effort**: 8 hours (M)
**Dependencies**: [001] (needs config system)
**Parallel**: false (briefing depends on this)

## Description

This task batches 4 Google service integrations into a single implementation, leveraging the existing Google OAuth infrastructure used for Google Tasks. This is more efficient than implementing each service separately, as they share authentication, error handling, and API patterns.

The implementation will provide voice access to calendar management, email operations, note-taking, and fitness data - covering the majority of daily personal management needs.

## Acceptance Criteria

- [ ] `google_auth.py` extended with scopes for Calendar, Gmail, Keep, Fit APIs
- [ ] `functions/google_services.py` created with ~15 function handlers
- [ ] Calendar: list events, create event, update event, delete event
- [ ] Gmail: list emails, read email, send email, search emails, mark read/unread
- [ ] Keep: create note, create list, add to list, query notes
- [ ] Fit: query steps, query activity, log workout
- [ ] Function schemas for all 15+ functions
- [ ] Token refresh logic robust and tested
- [ ] All functions registered in `functions/__init__.py`
- [ ] Voice commands working for calendar, email, notes, fitness

## Files Created/Modified

**New Files**:
- `functions/google_services.py` - Unified Google services integration (~400 lines)
- `functions/schemas.py` - Function schemas (if not inline)

**Modified Files**:
- `functions/google_auth.py` - Extend OAuth scopes for 4 APIs
- `functions/__init__.py` - Register all new functions
- `requirements.txt` - Add `google-api-python-client` if not present

## Technical Details

### OAuth Scopes

Add these scopes to `google_auth.py`:

```python
SCOPES = [
    'https://www.googleapis.com/auth/tasks',  # Existing
    'https://www.googleapis.com/auth/calendar',
    'https://www.googleapis.com/auth/gmail.modify',
    'https://www.googleapis.com/auth/keep',
    'https://www.googleapis.com/auth/fitness.activity.read',
    'https://www.googleapis.com/auth/fitness.activity.write',
]
```

### Calendar Functions

1. `list_calendar_events(start_date: str, end_date: str, max_results: int = 10)` - List upcoming events
2. `create_calendar_event(title: str, start_time: str, end_time: str, description: str = None)` - Create event
3. `update_calendar_event(event_id: str, **updates)` - Update existing event
4. `delete_calendar_event(event_id: str)` - Delete event

### Gmail Functions

5. `list_emails(max_results: int = 10, unread_only: bool = False)` - List recent emails
6. `read_email(email_id: str)` - Read full email content
7. `send_email(to: str, subject: str, body: str)` - Send email
8. `search_emails(query: str, max_results: int = 10)` - Search emails
9. `mark_email_read(email_id: str)` - Mark as read
10. `mark_email_unread(email_id: str)` - Mark as unread

### Keep Functions

11. `create_note(title: str, content: str)` - Create text note
12. `create_list(title: str, items: list[str])` - Create checklist
13. `add_to_list(list_id: str, item: str)` - Add item to existing list
14. `query_notes(search_term: str)` - Search notes

### Fit Functions

15. `get_steps(date: str = "today")` - Query step count
16. `get_activity_summary(date: str = "today")` - Activity summary
17. `log_workout(activity_type: str, duration_minutes: int, calories: int = None)` - Log workout

### Token Refresh Logic

Implement robust token refresh:

```python
def refresh_credentials(credentials):
    """Refresh expired Google OAuth tokens."""
    if credentials.expired and credentials.refresh_token:
        try:
            credentials.refresh(Request())
            save_credentials(credentials)
        except Exception as e:
            logger.error(f"Token refresh failed: {e}")
            raise AuthenticationError("Please re-authenticate")
    return credentials
```

## Dependencies

**External**:
- Google Calendar API
- Gmail API
- Google Keep API
- Google Fit API
- `google-api-python-client` library

**Internal**:
- Task 001 (configuration system)
- Existing `google_auth.py` OAuth infrastructure
- Existing function calling framework

## Testing Checklist

- [ ] OAuth scopes approved and tokens generated
- [ ] All 17 functions execute successfully
- [ ] Calendar: CRUD operations work correctly
- [ ] Gmail: Read, send, search operations work
- [ ] Keep: Notes and lists created successfully
- [ ] Fit: Activity data retrieved correctly
- [ ] Token refresh handles expired credentials
- [ ] Error handling for API failures
- [ ] Error handling for invalid parameters
- [ ] Function schemas validate
- [ ] Voice commands trigger correct functions
- [ ] All functions registered and callable

## Notes

- This is the largest single task in Phase 1 (8 hours)
- Batching saves ~4 hours vs implementing separately
- Leverage existing OAuth flow from Google Tasks integration
- Google Keep API may require special access - implement with fallback if unavailable
- Test token expiration by manually expiring credentials
- Follow existing patterns from `google_tasks.py` for consistency
- Use asyncio where appropriate for API calls in briefing context
