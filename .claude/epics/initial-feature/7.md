---
name: Home Assistant Integration
status: open
created: 2025-10-28T20:51:52Z
updated: 2025-10-28T21:06:48Z
github: https://github.com/zach-fau/home-assistant/issues/7
depends_on: [6]
parallel: true
conflicts_with: []
---

# Task: Home Assistant Integration

## Description
Implement comprehensive Home Assistant integration as a tool, enabling voice control of smart home devices, state queries, scene activation, and automation triggers. This is the highest-value tool, providing the core smart home control functionality that differentiates this assistant.

## Acceptance Criteria
- [ ] Home Assistant REST API client implemented with async support
- [ ] WebSocket connection for real-time state updates (optional but recommended)
- [ ] Device discovery and enumeration working
- [ ] State query functions (get device states, sensor values)
- [ ] Device control functions (lights, switches, thermostats, etc.)
- [ ] Scene and automation triggering
- [ ] Error handling for unreachable devices or failed commands
- [ ] Function definitions cover common smart home operations
- [ ] Natural language commands map correctly to device operations

## Technical Details
**Home Assistant Tool Functions:**
```python
class HomeAssistantTool:
    """Provides multiple function definitions for HA operations"""

    functions = [
        {
            "name": "control_light",
            "description": "Turn light on/off or set brightness",
            "parameters": {
                "entity_id": "string (light.kitchen)",
                "state": "on|off",
                "brightness_pct": "integer 0-100 (optional)"
            }
        },
        {
            "name": "get_device_state",
            "description": "Get current state of a device or sensor",
            "parameters": {
                "entity_id": "string or entity name"
            }
        },
        {
            "name": "set_temperature",
            "description": "Set thermostat temperature",
            "parameters": {
                "entity_id": "string (climate.living_room)",
                "temperature": "number"
            }
        },
        {
            "name": "activate_scene",
            "description": "Activate a Home Assistant scene",
            "parameters": {
                "scene_name": "string"
            }
        },
        {
            "name": "list_devices",
            "description": "List available devices by domain",
            "parameters": {
                "domain": "string (optional: light, switch, climate, etc.)"
            }
        }
    ]
```

**Implementation Approach:**
1. Create async Home Assistant client using aiohttp
2. Implement authentication with long-lived access token
3. Build REST API wrapper methods for common operations
4. (Optional) WebSocket connection for real-time state updates
5. Device name normalization (handle friendly names vs entity_ids)
6. Implement retry logic for transient failures
7. Register each function with the tool registry

**Configuration:**
```yaml
home_assistant:
  url: "http://homeassistant.local:8123"
  access_token: "${HA_ACCESS_TOKEN}"
  verify_ssl: true
```

**Natural Language Mapping:**
- "Turn on kitchen lights" → control_light(entity_id="light.kitchen", state="on")
- "Set living room to 72 degrees" → set_temperature(entity_id="climate.living_room", temperature=72)
- "Activate movie scene" → activate_scene(scene_name="movie")
- "What's the temperature in bedroom" → get_device_state(entity_id="sensor.bedroom_temperature")

**Error Handling:**
- Device not found → inform user, suggest available devices
- Command failed → retry once, then report error
- HA unreachable → queue command, notify user of connectivity issue

## Dependencies
- [ ] Task 003 (Function Calling Framework) completed
- [ ] Home Assistant instance running and accessible
- [ ] Home Assistant access token created
- [ ] Home Assistant URL configured in .env

## Effort Estimate
- Size: L
- Hours: 12-16 hours
- Parallel: true (can be developed alongside other tools once framework exists)

## Definition of Done
- [ ] Successfully controls lights (on/off, brightness)
- [ ] Successfully queries device states and sensor values
- [ ] Successfully controls thermostat temperature
- [ ] Successfully activates scenes
- [ ] Device discovery lists available entities
- [ ] Natural language commands work for all core operations
- [ ] Error messages are clear and actionable
- [ ] Command success rate > 98% for reachable devices
- [ ] Unit tests for each Home Assistant function
- [ ] Integration test: Complete a multi-step smart home scenario
- [ ] Documentation includes setup instructions for HA access token
